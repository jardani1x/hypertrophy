<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Flight Simulator - M0</title>
  <!-- Try multiple Cesium CDNs -->
  <script>
    window.CESIUM_CDNS = [
      'https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js',
      'https://cdnjs.cloudflare.com/ajax/libs/cesium/1.114.0/Cesium.js',
      'https://cesiumjs.org/releases/1.114/Build/Cesium/Cesium.js'
    ];
    window.CESIUM_CSS = [
      'https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css',
      'https://cdnjs.cloudflare.com/ajax/libs/cesium/1.114.0/Widgets/widgets.css'
    ];
    
    async function loadCesium() {
      for (let i = 0; i < window.CESIUM_CDNS.length; i++) {
        try {
          document.getElementById('loading-text').textContent = 'Loading Cesium CDN ' + (i+1) + '...';
          await new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = window.CESIUM_CDNS[i];
            script.onload = resolve;
            script.onerror = reject;
            document.head.appendChild(script);
          });
          
          // Load CSS
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = window.CESIUM_CSS[i];
          document.head.appendChild(link);
          
          console.log('Cesium loaded from CDN ' + (i+1));
          return true;
        } catch(e) {
          console.warn('CDN ' + (i+1) + ' failed:', e);
        }
      }
      throw new Error('All Cesium CDNs failed');
    }
  </script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      width: 100vw !important; height: 100vh !important; 
      overflow: hidden !important; background: #000; font-family: monospace;
    }
    #cesium-container { 
      width: 100vw !important; height: 100vh !important; 
      position: fixed !important; top: 0 !important; left: 0 !important;
    }
    .cesium-viewer, .cesium-widget, canvas {
      width: 100vw !important; height: 100vh !important;
    }
    .loading {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999;
    }
    .loading-content { text-align: center; }
    .loading-title {
      color: #00ff88; font-size: 32px; font-weight: 300;
      letter-spacing: 8px; margin-bottom: 10px;
      text-transform: uppercase;
    }
    .loading-subtitle {
      color: #666; font-size: 14px; margin-bottom: 30px;
      letter-spacing: 2px;
    }
    .loading-spinner {
      width: 50px; height: 50px;
      border: 3px solid #1a1a2e;
      border-top: 3px solid #00ff88;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading.hidden { display: none; }
    .hud {
      position: fixed; top: 20px; left: 20px;
      background: rgba(0,0,0,0.8); color: #0f0; padding: 15px;
      border-radius: 8px; z-index: 100; min-width: 180px;
    }
    .hud div { margin: 5px 0; }
    .controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.8); color: #888; padding: 10px 20px;
      border-radius: 20px; z-index: 100; font-size: 12px;
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">
    <div class="loading-content">
      <div class="loading-title">Flight Sim</div>
      <div class="loading-subtitle" id="loading-text">Loading Cesium engine...</div>
      <div class="loading-spinner"></div>
    </div>
  </div>
  <div id="cesium-container"></div>
  
  <div class="hud">
    <div>FPS: <span id="fps">--</span></div>
    <div>POS: <span id="pos">--</span></div>
    <div>HDG: <span id="hdg">--</span>¬∞</div>
    <div>ALT: <span id="alt">--</span> m</div>
    <div>SPD: <span id="spd">--</span> m/s</div>
    <div>THR: <span id="thr">--</span>%</div>
  </div>
  
  <div class="controls">
    W/S = Throttle | A/D = Roll | Arrow = Pitch/Turn | Q/E = Alt
  </div>

  <script>
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmZTVkZWJkZC1lMDdlLTQyYzMtYWIyNS01YmUzZTc4Y2JmMGIiLCJpZCI6MzkyOTEzLCJpYXQiOjE3NzE3MzAzNjh9.lNWe3qqelAGSjQAMwJv8jrHbdxKFmFYq7UB80y4O6CU';
    
    // State - Start on ground at Singapore Changi Airport
    const state = { 
      lon: 103.9915, 
      lat: 1.3644, 
      alt: 15, 
      heading: 90,
      pitch: 0,
      roll: 0,
      speed: 0,
      throttle: 0
    };
    
    // Aircraft physics - F-16 like
    const aircraft = {
      mass: 12000,      // kg
      wingArea: 28,      // m¬≤
      maxThrust: 80000, // N
      maxSpeed: 600,     // m/s
      stallSpeed: 60     // m/s
    };
    const keys = {};
    
    // Input
    document.addEventListener('keydown', e => {
      keys[e.code] = true;
      // Throttle controls
      if (e.code === 'KeyW') state.throttle = Math.min(1, state.throttle + 0.05);
      if (e.code === 'KeyS') state.throttle = Math.max(0, state.throttle - 0.05);
    });
    document.addEventListener('keyup', e => keys[e.code] = false);
    
    // Physics update
    function updatePhysics(dt) {
      const turn = 30 * dt;
      const airDensity = 1.225;
      
      // Throttle
      if (keys['ArrowUp']) state.throttle = Math.min(1, state.throttle + 0.02);
      if (keys['ArrowDown']) state.throttle = Math.max(0, state.throttle - 0.02);
      
      // Calculate forces
      const thrust = state.throttle * aircraft.maxThrust;
      const speed = state.speed;
      
      // Lift = 0.5 * œÅ * v¬≤ * S * CL
      const liftCoeff = 0.1 + state.pitch * 0.1;
      const lift = 0.5 * airDensity * speed * speed * aircraft.wingArea * liftCoeff;
      
      // Drag = 0.5 * œÅ * v¬≤ * S * CD
      const dragCoeff = 0.02 + state.throttle * 0.01;
      const drag = 0.5 * airDensity * speed * speed * aircraft.wingArea * dragCoeff;
      
      // Acceleration
      const acceleration = (thrust - drag) / aircraft.mass;
      
      // Update speed
      state.speed += acceleration * dt;
      state.speed = Math.max(0, state.speed);
      
      // Ground collision
      if (state.alt < 10 && state.speed < aircraft.stallSpeed) {
        state.speed = 0;
        state.alt = 10;
      }
      
      // Position update
      if (state.speed > 1) {
        const h = state.heading * Math.PI / 180;
        const move = state.speed * dt;
        
        state.lon += Math.sin(h) * move / 111320;
        state.lat += Math.cos(h) * move / 111320;
        
        // Climb/descent based on pitch
        if (state.speed > aircraft.stallSpeed) {
          state.alt += state.pitch * state.speed * dt * 0.01;
        }
      }
      state.alt = Math.max(10, state.alt);
      
      // Turn (based on roll)
      state.heading += state.roll * dt * 20;
      
      // Roll & Pitch from controls
      if (keys['KeyA']) state.roll = Math.max(-30, state.roll - 60 * dt);
      if (keys['KeyD']) state.roll = Math.min(30, state.roll + 60 * dt);
      if (keys['ArrowLeft']) state.heading -= turn;
      if (keys['ArrowRight']) state.heading += turn;
      
      // Pitch
      if (keys['ArrowUp']) state.pitch = Math.min(20, state.pitch + 30 * dt);
      if (keys['ArrowDown']) state.pitch = Math.max(-20, state.pitch - 30 * dt);
      
      // Auto-level roll
      state.roll *= 0.98;
      state.pitch *= 0.95;
      
      // HUD
      document.getElementById('pos').textContent = state.lon.toFixed(4) + ', ' + state.lat.toFixed(4);
      document.getElementById('hdg').textContent = ((state.heading%360+360)%360).toFixed(0);
      document.getElementById('alt').textContent = state.alt.toFixed(0);
      document.getElementById('spd').textContent = state.speed.toFixed(0);
      document.getElementById('thr').textContent = (state.throttle * 100).toFixed(0);
    }
      
      // FPS
      frameCount++;
      const now = performance.now();
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = frameCount;
        frameCount = 0;
        lastFpsTime = now;
      }
    }
    
    function log(msg) {
      console.log(msg);
      const el = document.getElementById('loading-text');
      if (el) el.textContent = msg;
    }
    
    async function init() {
      try {
        log('Loading Cesium engine...');
        await loadCesium();
        log('Initializing...');
      
      Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;
      log('Token set, creating terrain...');
      
      // Reset body
      document.body.style.margin = '0';
      document.body.style.padding = '0';
      
      const viewer = new Cesium.Viewer('cesium-container', {
        terrainProvider: await Cesium.createWorldTerrainAsync(),
        baseLayerPicker: false, geocoder: false, homeButton: false,
        sceneModePicker: false, selectionIndicator: false, timeline: false,
        animation: false, navigationHelpButton: false, fullscreenButton: false,
        infoBox: false, shouldAnimate: false
      });
      
      viewer.resize();
      document.getElementById('cesium-container').style.width = '100vw';
      document.getElementById('cesium-container').style.height = '100vh';
      
      log('Viewer created, adding aircraft...');
      
      // Aircraft - smaller model for faster loading
      const aircraft = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt),
        model: { 
          uri: 'https://cesium.com/public/Sandcastle/SampleData/models/CesiumAir/Cesium_Air.glb', 
          scale: 40,
          minimumPixelSize: 32
        },
        label: { 
          text: '‚úàÔ∏è F-16', 
          font: '28px sans-serif', 
          fillColor: Cesium.Color.YELLOW, 
          pixelOffset: new Cesium.Cartesian2(0, -80),
          showBackground: true,
          backgroundColor: new Cesium.Color(0,0,0,0.7)
        },
        point: {
          pixelSize: 20,
          color: Cesium.Color.RED,
          outlineColor: Cesium.Color.WHITE,
          outlineWidth: 2
        }
      });
      
      console.log('Aircraft added, waiting for model...');
      
      // Airport
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(103.9915, 1.3644, 0),
        point: { pixelSize: 12, color: Cesium.Color.CYAN },
        label: { text: 'üõ´ Singapore', font: '16px sans-serif' }
      });
      
      // Fly camera to start - closer to ground
      viewer.camera.flyTo({
        destination: Cesium.Cartesian3.fromDegrees(state.lon, state.lat - 0.001, state.alt + 100),
        orientation: {
          heading: Cesium.Math.toRadians(0),
          pitch: Cesium.Math.toRadians(-10),
          roll: 0
        },
        duration: 0
      });
      
      log('Ready to fly!');
      document.getElementById('loading').classList.add('hidden');
      
      function loop() {
        updatePhysics(1/60);
        
        aircraft.position = Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt);
        aircraft.orientation = Cesium.Transforms.headingPitchRollQuaternion(
          Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt),
          new Cesium.HeadingPitchRoll(
            Cesium.Math.toRadians(state.heading),
            Cesium.Math.toRadians(state.pitch),
            Cesium.Math.toRadians(state.roll)
          )
        );
        
        const h = state.heading * Math.PI/180;
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(state.lon - Math.sin(h)*0.02, state.lat - Math.cos(h)*0.02, state.alt + 300),
          orientation: { heading: Cesium.Math.toRadians(state.heading), pitch: Cesium.Math.toRadians(-20), roll: 0 }
        });
        
        requestAnimationFrame(loop);
      }
      loop();
    }
    
    init().catch(e => {
      console.error(e);
      log('ERROR: ' + e.message);
    });
  </script>
</body>
</html>
