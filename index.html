<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Flight Simulator - M3</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      width: 100vw !important; height: 100vh !important; 
      overflow: hidden !important; background: #000; font-family: monospace;
    }
    #cesium-container { 
      width: 100vw !important; height: 100vh !important; 
      position: fixed !important; top: 0 !important; left: 0 !important;
    }
    .cesium-viewer, .cesium-widget, canvas { width: 100vw !important; height: 100vh !important; }
    .loading {
      position: fixed; top: 0; left: 0; right: 0; bottom:0;
      background: linear-gradient(135deg,#0a0a0a,#1a1a2e);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 9999; color: #00ff88; font-size: 20px;
    }
    .loading.hidden { display: none; }
    .hud {
      position: fixed; top: 20px; left: 20px;
      background: rgba(0,0,0,0.85); color: #00ff88; padding: 15px;
      border-radius: 8px; z-index: 100; min-width: 200px;
    }
    .hud div { margin: 4px 0; display: flex; justify-content: space-between; }
    .hud span { color: #fff; }
    .controls {
      position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
      background: rgba(0,0,0,0.85); color: #888; padding: 10px 20px;
      border-radius: 20px; z-index: 100; font-size: 12px;
    }
    /* PFD - Primary Flight Display */
    .pfd {
      position: fixed; bottom: 20px; right: 20px;
      width: 180px; height: 180px;
      background: rgba(0,20,0,0.9); border: 2px solid #00ff88; border-radius: 50%;
      z-index: 100;
    }
    .pfd canvas { width: 100%; height: 100%; border-radius: 50%; }
    /* Touch controls */
    .touch-left, .touch-right {
      position: fixed; bottom: 30px; width: 120px; height: 120px;
      background: rgba(255,255,255,0.1); border-radius: 50%; border: 2px solid rgba(255,255,255,0.3);
      z-index: 200; display: none;
    }
    .touch-left { left: 30px; }
    .touch-right { right: 30px; }
    .touch-knob {
      position: absolute; top: 50%; left: 50%; width: 50px; height: 50px;
      background: rgba(0,255,0,0.5); border-radius: 50%;
      transform: translate(-50%, -50%);
    }
    /* Mobile: HUD and PFD side by side */
    @media (pointer: coarse) {
      .hud {
        top: 20px; left: 20px; right: auto;
      }
      .pfd {
        top: 20px; right: 20px; bottom: auto;
        width: 140px; height: 140px;
      }
      .pfd canvas { width: 140px; height: 140px; }
      .touch-left, .touch-right { display: block; }
      .touch-left { bottom: 30px; left: 20px; }
      .touch-right { bottom: 30px; right: 20px; }
      .controls { display: none; }
    }
    /* Desktop */
    @media (pointer: fine) {
      .pfd { bottom: 20px; right: 20px; }
      .hud { top: 20px; left: 20px; }
    }
  </style>
</head>
<body>
  <div class="loading" id="loading">Flight Sim - Loading...</div>
  <div id="cesium-container"></div>
  
  <div class="hud">
    <div>FPS: <span id="fps">--</span></div>
    <div>POS: <span id="pos">--</span></div>
    <div>HDG: <span id="hdg">--</span>Â°</div>
    <div>ALT: <span id="alt">--</span> m</div>
    <div>SPD: <span id="spd">--</span> m/s</div>
    <div>THR: <span id="thr">--</span>%</div>
    <div style="color:#888;margin-top:8px">MODE: <span id="mode">KEY</span></div>
  </div>
  
  <div class="pfd"><canvas id="pfd-canvas" width="180" height="180"></canvas></div>
  
  <div class="touch-left" id="touch-left"><div class="touch-knob" id="knob-left"></div></div>
  <div class="touch-right" id="touch-right"><div class="touch-knob" id="knob-right"></div></div>
  
  <div class="controls">W/S=Thr | A/D=Roll | Arrows=Pitch/Turn | Gamepad</div>

  <script>
    const CESIUM_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJmZTVkZWJkZC1lMDdlLTQyYzMtYWIyNS01YmUzZTc4Y2JmMGIiLCJpZCI6MzkyOTEzLCJpYXQiOjE3NzE3MzAzNjh9.lNWe3qqelAGSjQAMwJv8jrHbdxKFmFYq7UB80y4O6CU';
    
    // State
    const state = { lon: 103.9915, lat: 1.3644, alt: 15, heading: 90, pitch: 0, roll: 0, speed: 0, throttle: 0 };
    const aircraftPhys = { mass: 12000, wingArea: 28, maxThrust: 80000 };
    const keys = {};
    let controlMode = 'KEY';
    
    // Input handlers
    document.addEventListener('keydown', e => {
      keys[e.code] = true;
      if (e.code === 'KeyW') state.throttle = Math.min(1, state.throttle + 0.05);
      if (e.code === 'KeyS') state.throttle = Math.max(0, state.throttle - 0.05);
    });
    document.addEventListener('keyup', e => keys[e.code] = false);
    
    // Gamepad
    window.addEventListener('gamepadconnected', () => controlMode = 'GAMEPAD');
    window.addEventListener('gamepaddisconnected', () => controlMode = 'KEY');
    
    // Touch controls
    const touchState = { left: {x:0,y:0}, right: {x:0,y:0} };
    function setupTouch() {
      const left = document.getElementById('touch-left'), right = document.getElementById('touch-right');
      const kLeft = document.getElementById('knob-left'), kRight = document.getElementById('knob-right');
      let leftId, rightId;
      
      left.addEventListener('touchstart', e => { leftId = e.changedTouches[0].identifier; controlMode = 'TOUCH'; });
      left.addEventListener('touchmove', e => {
        for (let t of e.changedTouches) if (t.identifier === leftId) {
          const r = left.getBoundingClientRect();
          touchState.left.x = Math.max(-1, Math.min(1, (t.clientX - r.left - 60) / 40));
          touchState.left.y = Math.max(-1, Math.min(1, (t.clientY - r.top - 60) / 40));
          kLeft.style.transform = `translate(calc(-50% + ${touchState.left.x*25}px), calc(-50% + ${touchState.left.y*25}px))`;
        }
      });
      left.addEventListener('touchend', e => { for (let t of e.changedTouches) if (t.identifier === leftId) { touchState.left = {x:0,y:0}; kLeft.style.transform = 'translate(-50%,-50%)'; } });
      
      right.addEventListener('touchstart', e => { rightId = e.changedTouches[0].identifier; controlMode = 'TOUCH'; });
      right.addEventListener('touchmove', e => {
        for (let t of e.changedTouches) if (t.identifier === rightId) {
          const r = right.getBoundingClientRect();
          touchState.right.x = Math.max(-1, Math.min(1, (t.clientX - r.left - 60) / 40));
          touchState.right.y = Math.max(-1, Math.min(1, (t.clientY - r.top - 60) / 40));
          kRight.style.transform = `translate(calc(-50% + ${touchState.right.x*25}px), calc(-50% + ${touchState.right.y*25}px))`;
        }
      });
      right.addEventListener('touchend', e => { for (let t of e.changedTouches) if (t.identifier === rightId) { touchState.right = {x:0,y:0}; kRight.style.transform = 'translate(-50%,-50%)'; } });
    }
    setupTouch();
    
    // FPS
    let frameCount = 0, lastFpsTime = performance.now();
    
    // Physics
    function update(dt) {
      const gp = navigator.getGamepads()[0];
      
      // Get inputs based on mode
      let pitch = 0, roll = 0, yaw = 0;
      
      if (controlMode === 'KEY') {
        if (keys['ArrowUp']) pitch = 1;
        if (keys['ArrowDown']) pitch = -1;
        if (keys['KeyA']) roll = -1;
        if (keys['KeyD']) roll = 1;
        if (keys['ArrowLeft']) yaw = -1;
        if (keys['ArrowRight']) yaw = 1;
      } else if (controlMode === 'GAMEPAD' && gp) {
        if (Math.abs(gp.axes[1]) > 0.1) pitch = -gp.axes[1];
        if (Math.abs(gp.axes[0]) > 0.1) roll = gp.axes[0];
        if (Math.abs(gp.axes[2]) > 0.1) yaw = gp.axes[2];
        const lt = gp.buttons[6]?.value || 0, rt = gp.buttons[7]?.value || 0;
        state.throttle = Math.max(0, Math.min(1, state.throttle + (rt - lt) * 0.02));
      } else if (controlMode === 'TOUCH') {
        roll = touchState.left.x;
        yaw = touchState.left.y;
        pitch = -touchState.right.y;
      }
      
      // Throttle
      if (controlMode === 'KEY') {
        if (keys['ArrowUp']) state.throttle = Math.min(1, state.throttle + 0.02);
        if (keys['ArrowDown']) state.throttle = Math.max(0, state.throttle - 0.02);
      }
      
      // Physics
      const thrust = state.throttle * aircraftPhys.maxThrust;
      const speed = state.speed;
      const lift = 0.5 * 1.225 * speed * speed * aircraftPhys.wingArea * 0.1;
      const drag = 0.5 * 1.225 * speed * speed * aircraftPhys.wingArea * 0.02;
      
      state.speed += (thrust - drag) / aircraftPhys.mass * dt;
      state.speed = Math.max(0, state.speed);
      
      if (state.speed > 1) {
        const h = state.heading * Math.PI / 180;
        state.lon += Math.sin(h) * state.speed * dt / 111320;
        state.lat += Math.cos(h) * state.speed * dt / 111320;
      }
      
      // Attitude
      state.roll += roll * 60 * dt;
      state.pitch += pitch * 30 * dt;
      state.heading += yaw * 30 * dt;
      state.roll *= 0.95;
      state.pitch *= 0.9;
      
      // Altitude
      if (state.speed > 20) state.alt += state.pitch * state.speed * dt * 0.01;
      state.alt = Math.max(10, state.alt);
      
      // HUD
      document.getElementById('pos').textContent = state.lon.toFixed(4) + ',' + state.lat.toFixed(4);
      document.getElementById('hdg').textContent = ((state.heading%360+360)%360).toFixed(0);
      document.getElementById('alt').textContent = state.alt.toFixed(0);
      document.getElementById('spd').textContent = state.speed.toFixed(0);
      document.getElementById('thr').textContent = (state.throttle*100).toFixed(0);
      document.getElementById('mode').textContent = controlMode;
      
      frameCount++;
      const now = performance.now();
      if (now - lastFpsTime >= 1000) {
        document.getElementById('fps').textContent = frameCount;
        frameCount = 0; lastFpsTime = now;
      }
    }
    
    // PFD
    function drawPFD() {
      const c = document.getElementById('pfd-canvas');
      const ctx = c.getContext('2d');
      const w = 180, h = 180, cx = w/2, cy = h/2;
      
      ctx.fillStyle = '#001a00';
      ctx.fillRect(0,0,w,h);
      
      const pitchScale = 3;
      ctx.strokeStyle = '#00ff88';
      ctx.lineWidth = 1;
      
      for (let p = -90; p <= 90; p += 10) {
        const y = cy - (state.pitch - p) * pitchScale;
        if (y > 10 && y < h-10) {
          const lw = p === 0 ? 50 : p%30===0 ? 35 : 20;
          ctx.beginPath(); ctx.moveTo(cx-lw,y); ctx.lineTo(cx+lw,y); ctx.stroke();
        }
      }
      
      // Roll
      ctx.save(); ctx.translate(cx,25); ctx.rotate(-state.roll*Math.PI/180);
      ctx.fillStyle = '#00ff88'; ctx.beginPath();
      ctx.moveTo(0,0); ctx.lineTo(-10,-12); ctx.lineTo(10,-12); ctx.closePath(); ctx.fill();
      ctx.restore();
      
      // Center
      ctx.fillStyle = '#ff0';
      ctx.beginPath(); ctx.moveTo(cx-15,cy); ctx.lineTo(cx+15,cy); ctx.lineTo(cx,cy-10); ctx.lineTo(cx,cy+10); ctx.fill();
      
      // Heading
      ctx.fillStyle = '#00ff88';
      ctx.font = '12px monospace';
      ctx.textAlign = 'center';
      ctx.fillText(((state.heading%360+360)%360).toFixed(0)+'Â°', cx, h-10);
    }
    
    async function init() {
      Cesium.Ion.defaultAccessToken = CESIUM_TOKEN;
      document.body.style.margin = '0';
      
      const viewer = new Cesium.Viewer('cesium-container', {
        terrainProvider: await Cesium.createWorldTerrainAsync(),
        baseLayerPicker: false, geocoder: false, homeButton: false,
        sceneModePicker: false, selectionIndicator: false, timeline: false,
        animation: false, navigationHelpButton: false, fullscreenButton: false,
        infoBox: false, shouldAnimate: false
      });
      
      const aircraft = viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt),
        model: { uri: 'https://cesium.com/public/Sandcastle/SampleData/models/CesiumAir/Cesium_Air.glb', scale: 50 },
        label: { text: 'âœˆï¸ F-16', font: '24px sans-serif', fillColor: Cesium.Color.YELLOW, pixelOffset: new Cesium.Cartesian2(0,-60) },
        point: { pixelSize: 15, color: Cesium.Color.RED }
      });
      
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(103.9915, 1.3644, 0),
        point: { pixelSize: 12, color: Cesium.Color.CYAN },
        label: { text: 'ðŸ›« Singapore', font: '16px sans-serif' }
      });
      
      document.getElementById('loading').classList.add('hidden');
      
      let last = performance.now();
      function loop() {
        const now = performance.now();
        update((now - last) / 1000);
        last = now;
        
        aircraft.position = Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt);
        aircraft.orientation = Cesium.Transforms.headingPitchRollQuaternion(
          Cesium.Cartesian3.fromDegrees(state.lon, state.lat, state.alt),
          new Cesium.HeadingPitchRoll(Cesium.Math.toRadians(state.heading), Cesium.Math.toRadians(state.pitch), Cesium.Math.toRadians(state.roll))
        );
        
        const h = state.heading * Math.PI/180;
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(state.lon - Math.sin(h)*0.02, state.lat - Math.cos(h)*0.02, state.alt + 300),
          orientation: { heading: Cesium.Math.toRadians(state.heading), pitch: Cesium.Math.toRadians(-15), roll: 0 }
        });
        
        drawPFD();
        requestAnimationFrame(loop);
      }
      loop();
    }
    
    init();
  </script>
</body>
</html>
